<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposals</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Add any additional CSS libraries here -->
</head>
<body>
    <div class="container mt-5">
        <div class="proposal-container">
            <div class="row mb-4">
                <div class="col-12">
                    <a href="{{ url_for('create_proposal') }}" class="btn btn-primary proposal-create-btn">Create New Proposal</a>
                </div>
            </div>

            <div class="row">
                <!-- Left column: List of proposal titles -->
                <div class="col-md-3 proposal-list-container">
                    <div class="proposal-card">
                        <div class="proposal-card-header">
                            <h4>Proposals</h4>
                        </div>
                        <div class="proposal-card-body">
                            <ul class="list-group proposal-list" id="proposal-list">
                                <!-- Proposal list items will be dynamically inserted here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Right column: Detailed view of selected proposal -->
                <div class="col-md-9 proposal-detail-container">
                    <div id="proposal-details">
                        <!-- Proposal details will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
        fetchProposals();
    });

    function fetchProposals() {
        console.log('Fetching proposals...');
        fetch('/proposals/get', {
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(proposals => {
            console.log('Received proposals data:', proposals);
            if (Array.isArray(proposals)) {
                updateProposalsList(proposals);
                updateProposalDetails(proposals);
                // Show the first proposal by default
                if (proposals.length > 0) {
                    showProposal(proposals[0].id);
                }
            } else {
                console.error('Invalid data format received:', proposals);
                throw new Error('Invalid data format received from server');
            }
        })
        .catch(error => {
            console.error('Error fetching proposals:', error.message);
            displayErrorMessage('Failed to fetch proposals. Please try again later.');
        });
    }

    function displayErrorMessage(message) {
        let errorElement = document.getElementById('error-message');
        if (!errorElement) {
            errorElement = document.createElement('div');
            errorElement.id = 'error-message';
            errorElement.style.color = 'red';
            errorElement.style.marginBottom = '10px';
            document.querySelector('.proposal-container').prepend(errorElement);
        }
        errorElement.textContent = message;
    }

    function updateProposalsList(proposals) {
        const proposalList = document.getElementById('proposal-list');
        proposalList.innerHTML = ''; // Clear existing list
        proposals.forEach(proposal => {
            const listItem = document.createElement('li');
            listItem.className = 'proposal-list-item';
            listItem.onclick = () => showProposal(proposal.id);
            listItem.id = `proposal-item-${proposal.id}`;
            listItem.textContent = proposal.title;
            proposalList.appendChild(listItem);
        });
    }

    function updateProposalDetails(proposals) {
        const proposalDetails = document.getElementById('proposal-details');
        proposalDetails.innerHTML = ''; // Clear existing details
        proposals.forEach(proposal => {
            const detailDiv = document.createElement('div');
            detailDiv.id = `proposal-${proposal.id}`;
            detailDiv.className = 'proposal-detail';
            detailDiv.style.display = 'none';
            
            let optionsHtml = '';
            let resultsHtml = '';
            
            const options = JSON.parse(proposal.options);
            if (Array.isArray(options)) {
                options.forEach(option => {
                    optionsHtml += `
                        <button class="btn btn-primary proposal-vote-btn" onclick="submitVote('${proposal.id}', '${option}')">
                            Vote ${option}
                        </button>
                    `;
                    resultsHtml += `
                        <p>${option} Votes: <span id="${option.toLowerCase()}-votes-${proposal.id}">0</span></p>
                    `;
                });
            }

            detailDiv.innerHTML = `
                <div class="proposal-card">
                    <div class="proposal-card-header">
                        <div class="proposal-icon-shape bg-gradient-primary text-white">
                            <i class="material-icons">thumbs_up_down</i>
                        </div>
                        <h4 class="text-center">${proposal.title}</h4>
                    </div>
                    <div class="proposal-card-body">
                        ${proposal.image_url ? `<img src="${proposal.image_url}" alt="${proposal.title}" class="proposal-detail-img"/>` : ''}
                        <p>${proposal.description}</p>
                        <div id="vote-options-${proposal.id}">
                            ${optionsHtml}
                        </div>
                        <div id="vote-results-${proposal.id}">
                            ${resultsHtml}
                        </div>
                        <span id="voted-message-${proposal.id}" class="proposal-voted-message" style="display: none;">You have already voted for this proposal.</span>
                    </div>
                </div>
            `;
            proposalDetails.appendChild(detailDiv);
        });
    }

    function showProposal(proposalId) {
        // Hide all proposal details
        document.querySelectorAll('.proposal-detail').forEach(el => {
            el.style.display = 'none';
        });
        // Show the selected proposal
        const selectedProposal = document.getElementById('proposal-' + proposalId);
        if (selectedProposal) {
            selectedProposal.style.display = 'block';
        }
        // Update active state in the list
        document.querySelectorAll('.proposal-list-item').forEach(el => {
            el.classList.remove('active');
        });
        const selectedItem = document.getElementById('proposal-item-' + proposalId);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }
        // Fetch the latest vote counts
        fetchProposalVotes(proposalId);
    }

    function submitVote(proposalId, vote) {
        console.log(`Submitting vote: proposal_id=${proposalId}, vote=${vote}`);
        
        fetch('/proposal/vote/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                proposal_id: proposalId,
                vote: vote
            }),
        })
        .then(response => response.text())
        .then(data => {
            console.log('Server response:', data);
            if (data === 'OK') {
                console.log('Vote submitted successfully');
                fetchProposalVotes(proposalId);  // Refresh vote counts
                disableVoteButtons(proposalId);
                showVotedMessage(proposalId);
            } else {
                console.error('Vote failed:', data);
                alert('Failed to submit vote: ' + data);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('An error occurred while submitting your vote. Please check the console for more details and try again later.');
        });
    }

    function updateVoteCounts(proposalId, votes) {
        const voteResultsDiv = document.getElementById(`vote-results-${proposalId}`);
        if (!voteResultsDiv) return;

        const voteCounts = {};
        votes.forEach(vote => {
            if (voteCounts[vote.vote]) {
                voteCounts[vote.vote]++;
            } else {
                voteCounts[vote.vote] = 1;
            }
        });

        for (const [option, count] of Object.entries(voteCounts)) {
            const voteElement = document.getElementById(`${option.toLowerCase()}-votes-${proposalId}`);
            if (voteElement) {
                voteElement.textContent = count;
            }
        }
    }

    function disableVoteButtons(proposalId) {
        const voteOptionsDiv = document.getElementById(`vote-options-${proposalId}`);
        const buttons = voteOptionsDiv.querySelectorAll('button');
        buttons.forEach(button => button.disabled = true);
    }

    function showVotedMessage(proposalId) {
        document.getElementById(`voted-message-${proposalId}`).style.display = 'block';
    }

    function fetchProposalVotes(proposalId) {
        fetch(`/proposal/votes/get/${proposalId}`)
        .then(response => response.json())
        .then(votes => {
            if (Array.isArray(votes)) {
                updateVoteCounts(proposalId, votes);
            } else {
                console.error('Invalid vote data format received:', votes);
            }
        })
        .catch(error => {
            console.error('Error fetching updated vote counts:', error);
        });
    }
</script>
</body>
</html>