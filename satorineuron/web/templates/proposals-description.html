<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposals</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Add any additional CSS libraries here -->
</head>
<body>
    <div class="container mt-5">
        <div class="proposal-container">
            <div class="row mb-4">
                <div class="col-12">
                    <a href="{{ url_for('create_proposal') }}" class="btn btn-primary proposal-create-btn">Create New Proposal</a>
                </div>
            </div>

            <div class="row">
                <!-- Left column: List of proposal titles -->
                <div class="col-md-3 proposal-list-container">
                    <div class="proposal-card">
                        <div class="proposal-card-header">
                            <h4>Proposals</h4>
                        </div>
                        <div class="proposal-card-body">
                            <ul class="list-group proposal-list" id="proposal-list">
                                <!-- Proposal list items will be dynamically inserted here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Right column: Detailed view of selected proposal -->
                <div class="col-md-9 proposal-detail-container">
                    <div id="proposal-details">
                        <!-- Proposal details will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            fetchProposals();
        });
    
        function fetchProposals() {
            console.log('Fetching proposals...');
            fetch('/proposals', {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received proposals data:', data);
                if (data.status === 'success' && Array.isArray(data.proposals)) {
                    updateProposalsList(data.proposals);
                    updateProposalDetails(data.proposals);
                    // Show the first proposal by default
                    if (data.proposals.length > 0) {
                        showProposal(data.proposals[0].id);
                    }
                } else {
                    console.error('Invalid data format received:', data);
                    throw new Error('Invalid data format received from server');
                }
            })
            .catch(error => {
                console.error('Error fetching proposals:', error.message);
                displayErrorMessage('Failed to fetch proposals. Please try again later.');
            });
        }
    
        function updateProposalsList(proposals) {
            const proposalList = document.getElementById('proposal-list');
            proposalList.innerHTML = ''; // Clear existing list
            proposals.forEach(proposal => {
                const listItem = document.createElement('li');
                listItem.className = 'proposal-list-item';
                listItem.onclick = () => showProposal(proposal.id);
                listItem.id = `proposal-item-${proposal.id}`;
                listItem.textContent = proposal.title;
                proposalList.appendChild(listItem);
            });
        }
    
        function updateProposalDetails(proposals) {
            const proposalDetails = document.getElementById('proposal-details');
            proposalDetails.innerHTML = ''; // Clear existing details
            proposals.forEach(proposal => {
                const detailDiv = document.createElement('div');
                detailDiv.id = `proposal-${proposal.id}`;
                detailDiv.className = 'proposal-detail';
                detailDiv.style.display = 'none';
                
                let optionsHtml = '';
                let resultsHtml = '';
                
                // Parse the options string correctly
                const options = JSON.parse(JSON.parse(proposal.options));
                if (Array.isArray(options)) {
                    options.forEach(option => {
                        optionsHtml += `
                            <button class="btn btn-primary vote-btn" onclick="submitVote(${proposal.id}, '${option}')">
                                Vote for ${option}
                            </button>
                        `;
                        resultsHtml += `
                            <p>${option} Votes: <span id="${option.toLowerCase()}-votes-${proposal.id}">0</span></p>
                        `;
                    });
                }
    
                detailDiv.innerHTML = `
                    <div class="proposal-card">
                        <div class="proposal-card-header">
                            <div class="proposal-icon-shape bg-gradient-primary text-white">
                                <i class="material-icons">thumbs_up_down</i>
                            </div>
                            <h4 class="text-center">${proposal.title}</h4>
                        </div>
                        <div class="proposal-card-body" data-options='${JSON.stringify(options)}'>
                            ${proposal.image_url ? `<img src="${proposal.image_url}" alt="${proposal.title}" class="proposal-detail-img"/>` : ''}
                            <p><strong>Description:</strong> ${proposal.description}</p>
                            <p><strong>Cost:</strong> ${proposal.cost}</p>
                            <p><strong>Proposal Date:</strong> ${new Date(proposal.proposal_date).toLocaleString()}</p>
                            <p><strong>Expires:</strong> ${new Date(proposal.expires).toLocaleString()}</p>
                            ${proposal.complete_date ? `<p><strong>Completed:</strong> ${new Date(proposal.complete_date).toLocaleString()}</p>` : ''}
                            <div id="vote-options-${proposal.id}">
                                ${optionsHtml}
                            </div>
                            <div id="vote-results-${proposal.id}">
                                ${resultsHtml}
                            </div>
                            <span id="voted-message-${proposal.id}" class="proposal-voted-message" style="display: none;">You have already voted for this proposal.</span>
                        </div>
                    </div>
                `;
                proposalDetails.appendChild(detailDiv);
            });
        }
    
        function showProposal(id) {F
            // Hide all proposal details
            document.querySelectorAll('.proposal-detail').forEach(el => {
                el.style.display = 'none';
            });
            // Show the selected proposal
            const selectedProposal = document.getElementById('proposal-' + id);
            if (selectedProposal) {
                selectedProposal.style.display = 'block';
            }
            // Update active state in the list
            document.querySelectorAll('.proposal-list-item').forEach(el => {
                el.classList.remove('active');
            });
            const selectedItem = document.getElementById('proposal-item-' + id);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
        }
    
        function submitVote(id, vote) {
    console.log(`Submitting vote: proposal_id=${id}, vote=${vote}`);
    
    fetch('/proposals/vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            proposal_id: String(id),  // Ensure id is sent as a string
            vote: vote
        }),
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        console.log('Server response:', data);
        if (data.status === 'success') {
            console.log('Vote submitted successfully');
            fetchProposalVotes(id);
            disableVoteButtons(id);
            showVotedMessage(id);
        } else {
            throw new Error(data.message || 'Unknown error');
        }
    })
    .catch((error) => {
        console.error('Vote failed:', error.message);
        alert('Failed to submit vote: ' + error.message);
    });
}


        function fetchProposalVotes(id) {
            fetch(`/proposal/votes/get/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received vote data:', data);
                if (data.status === 'success') {
                    updateVoteCounts(id, data.votes);
                } else {
                    console.error('Failed to fetch vote counts:', data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching updated vote counts:', error);
            });
        }
    
        function updateVoteCounts(id, votes) {
            const proposalDetail = document.getElementById(`proposal-${id}`);
            if (!proposalDetail) return;
    
            const optionsString = proposalDetail.querySelector('.proposal-card-body').dataset.options;
            const options = JSON.parse(optionsString);
    
            options.forEach(option => {
                const voteElement = document.getElementById(`${option.toLowerCase()}-votes-${id}`);
                if (voteElement) {
                    voteElement.textContent = votes[option] || 0;
                }
            });
        }
    
        function disableVoteButtons(id) {
            const voteOptionsDiv = document.getElementById(`vote-options-${id}`);
            const buttons = voteOptionsDiv.querySelectorAll('.vote-btn');
            buttons.forEach(button => button.disabled = true);
        }
    
        function showVotedMessage(id) {
            document.getElementById(`voted-message-${id}`).style.display = 'block';
        }
    
        function displayErrorMessage(message) {
            let errorElement = document.getElementById('error-message');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = 'error-message';
                errorElement.style.color = 'red';
                errorElement.style.marginBottom = '10px';
                document.querySelector('.proposal-container').prepend(errorElement);
            }
            errorElement.textContent = message;
        }
    </script>