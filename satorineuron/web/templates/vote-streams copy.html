{% block content %}
<div class="row mb-4">
  <div class="col-lg-12 col-md-12 mb-md-0 mb-4">
    <div class="card {% if darkmode %}dark-colors{% endif %}">
      <div class="card-header pb-0  {% if darkmode %}dark-colors{% endif %}">
        <div class="row">
          <div class="col-lg-6 col-7">
            <h6 class="{% if darkmode %}dark-colors{% endif %}">Oracle Streams</h6>
            <p class="text-sm mb-0  {% if darkmode %}dark-colors{% endif %}">
              Data streams published by Satori Neurons.
              <br>
              Please vote on which data streams should be predicted.
            </p>
          </div>
        </div>
      </div>
      <div class="card-body px-0 pb-2">
        <div class="table-responsive" style="padding-left:1rem;padding-right:1rem;">
          <table class="table align-items-center mb-0">
            <thead>
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 {% if darkmode %}dark-colors{% endif %}">Oracle</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 {% if darkmode %}dark-colors{% endif %}">Stream</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 {% if darkmode %}dark-colors{% endif %}">Target</th>
                <!--<th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 {% if darkmode %}dark-colors{% endif %}">Cadence</th>-->
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 {% if darkmode %}dark-colors{% endif %}">Sanctioned</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 {% if darkmode %}dark-colors{% endif %}">Wallet Vote</th>
                {%if vault.isDecrypted %}
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 {% if darkmode %}dark-colors{% endif %}">Vault Vote</th>
                {% endif %}
              </tr>
            </thead>
            <tbody id="updating_table">
              <tr class="{% if darkmode %}yellow-dark-hover{% else %}yellow-hover{% endif %}" onmouseover="">
                <td colspan="3">
                </td>
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}"></h6>
                  </div>
                </td>
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 id='streamsWalletVoteTotal' class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}"></h6>
                  </div>
                </td>
                {%if vault.isDecrypted %}
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 id='streamsVaultVoteTotal' class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}"></h6>
                  </div>
                </td>
                {% endif %}
              </tr> 
              {% for stream in streams %}
              <tr class="{% if darkmode %}yellow-dark-hover{% else %}yellow-hover{% endif %}" onmouseover="">
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}" title="{{ stream['oracle_address'] }}">{{ stream['oracle_alias'] or stream['oracle_address']  }}</h6>
                  </div>
                </td>
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}">{{ stream['stream'] }}</h6>
                  </div>
                </td>
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}">{{ stream['target'] }}</h6>
                  </div>
                </td>
                <!--<td>
                  <div class="d-flex px-3 py-1">
                    <h6 class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}">{{ stream['cadence'] }}</h6>
                  </div>
                </td>-->
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 {% if darkmode %}dark-colors{% endif %}">{{ stream['sanctioned'] if stream['sanctioned'] > 0 else 0 }}</h6>
                  </div>
                </td>
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}">
                      <div class="d-flex px-3 py-1" style="padding: 1px !important; margin-bottom: .5rem;">
                        <div class="input-group input-group-outline">
                          <input id="streamIdWallet_{{stream['stream_id']}}" name="streamIdWallet_{{stream['stream_id']}}" placeholder="{{ stream['wallet_vote'] if stream['wallet_vote'] != 0 else '' }}" value="{{ stream['wallet_vote'] if stream['wallet_vote'] != 0 else '' }}" class="tight form-control {% if darkmode %}dark-colors{% endif %} streamWalletVoteIdentifier" style="text-align: end;" max="100" min="0" required="" size="3" type="number" onfocus="focused(this)" onfocusout="defocused(this)" onChange="validateWalletStreamsVotes();saveStreamVotesWallet();">
                        </div>
                      </div>
                    </h6>
                  </div>
                </td>
                {%if vault.isDecrypted %}
                <td>
                  <div class="d-flex px-3 py-1">
                    <h6 class="mb-0 text-sm  {% if darkmode %}dark-text{% endif %}">
                      <div class="d-flex px-3 py-1" style="padding: 1px !important; margin-bottom: .5rem;">
                        <div class="input-group input-group-outline">
                          <input id="streamIdVault_{{stream['stream_id']}}" name="streamIdVault_{{stream['stream_id']}}" placeholder="{{ stream['vault_vote'] if stream['vault_vote'] != 0 else '' }}" value="{{ stream['vault_vote'] if stream['vault_vote'] != 0 else '' }}" class="tight form-control {% if darkmode %}dark-colors{% endif %} streamVaultVoteIdentifier" style="text-align: end;" max="100" min="0" required="" size="3" type="number" onfocus="focused(this)" onfocusout="defocused(this)" onChange="validateVaultStreamsVotes();saveStreamVotesVault();">
                        </div>
                      </div>
                    </h6>
                  </div>
                </td>
                {% endif %}
              </tr> 
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function validateWalletStreamsVotes() {
    updateWalletStreamsTotal();
    let total = parseFloat(document.getElementById('streamsWalletVoteTotal').innerHTML.split(' ')[0]);
    if (total > 100.0) {
      for (const element of document.getElementsByClassName('streamWalletVoteIdentifier')) {
        element.value = parseInt(parseInt(element.value) / total * 100);
      }
      updateWalletStreamsTotal();
    } 
    return true;
  }
  function validateVaultStreamsVotes() {
    updateVaultStreamsTotal();
    let total = parseFloat(document.getElementById('streamsVaultVoteTotal').innerHTML.split(' ')[0]);
    if (total > 100.0) {
      for (const element of document.getElementsByClassName('streamVaultVoteIdentifier')) {
        element.value = parseInt(parseInt(element.value) / total * 100);
      }
      updateVaultStreamsTotal();
    } 
    return true;
  }
  function updateWalletStreamsTotal() {
    try {
      let total = 0;
      for (const element of document.getElementsByClassName('streamWalletVoteIdentifier')) {
        total += parseInt(element.value) || 0;
      }
      document.getElementById('streamsWalletVoteTotal').innerHTML = total + ' %';
    } catch (error) {
      document.getElementById('streamsWalletVoteTotal').innerHTML = 0 + ' %';
    }
  }
  function updateVaultStreamsTotal() {
    try {
      var total = 0;
      for (const element of document.getElementsByClassName('streamVaultVoteIdentifier')) {
        total += parseInt(element.value) || 0;
      }
      document.getElementById('streamsVaultVoteTotal').innerHTML = total + ' %';
    } catch (error) {
      document.getElementById('streamsVaultVoteTotal').innerHTML = 0 + ' %';
    }
  }
  function saveStreamVotesWallet() {
    let walletStreamIds = [];
    let walletVotes = [];
    for (const element of document.getElementsByClassName('streamWalletVoteIdentifier')) {
      const voteValue = parseInt(element.value) || 0;
      if (voteValue > 0) {
        walletStreamIds.push(parseInt(element.name.split('_')[1]));
        walletVotes.push(voteValue);
      }
    }
    fetch(
      '/vote/submit/sanction/wallet', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          walletStreamIds: walletStreamIds,
          walletVotes: walletVotes,
        })})
    .then(response => {
        if (response.ok) {
            console.log("stream votes submitted");
        }
    })
    .catch(error => console.error('Error:', error));
  }
  function saveStreamVotesVault() {
    let vaultStreamIds = [];
    let vaultVotes = [];
    for (const element of document.getElementsByClassName('streamVaultVoteIdentifier')) {
      const voteValue = parseInt(element.value) || 0;
      if (voteValue > 0) {
        vaultStreamIds.push(parseInt(element.name.split('_')[1]));
        vaultVotes.push(voteValue);
      }
    }
    fetch(
      '/vote/submit/sanction/vault', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          vaultStreamIds: vaultStreamIds,
          vaultVotes: vaultVotes,
        })})
    .then(response => {
        if (response.ok) {
            console.log("stream votes submitted");
        }
    })
    .catch(error => console.error('Error:', error));
  }

</script>
<script>updateVaultTotal();updateVaultStreamsTotal();</script>
{% endblock %}
